buildscript {
    dependencies {
        classpath 'org.postgresql:postgresql:42.7.1'
        classpath 'org.flywaydb:flyway-database-postgresql:10.4.1'
    }
}

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.0'
    id 'io.spring.dependency-management' version '1.1.4'
    id 'org.flywaydb.flyway' version '10.4.1'
}

group = 'com.glimpse'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // Spring Boot Starters
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    
    // Database
    runtimeOnly 'com.h2database:h2'
    implementation 'org.postgresql:postgresql'  // Flyway í”ŒëŸ¬ê·¸ì¸ë„ ì‚¬ìš©í•˜ë„ë¡ implementationìœ¼ë¡œ ë³€ê²½
    
    // Database Migration
    implementation 'org.flywaydb:flyway-core:10.4.1'
    implementation 'org.flywaydb:flyway-database-postgresql:10.4.1'  // Flyway í”ŒëŸ¬ê·¸ì¸ë„ ì‚¬ìš©í•˜ë„ë¡ implementationìœ¼ë¡œ ë³€ê²½
    
    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // Swagger/OpenAPI
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'
    
    // ModelMapper
    implementation 'org.modelmapper:modelmapper:3.2.0'
    
    // JWT
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
    
    // Development Tools
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    
    // Testing
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') {
    useJUnitPlatform()
}

springBoot {
    mainClass = 'com.glimpse.server.GlimpseApplication'
}

// bootRun configuration - uses application.properties by default

// ============================================================================
// Flyway Configuration
// ============================================================================
flyway {
    url = 'jdbc:postgresql://localhost:5432/glimpse_local'
    user = 'glimpse'
    password = 'glimpse123'
    locations = ['filesystem:src/main/resources/db/migration']
    schemas = ['public']
    baselineOnMigrate = true
    validateOnMigrate = true
    
    // âš ï¸ WARNING: flywayCleanì€ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!
    // ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”. Productionì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€!
    cleanDisabled = false  // ë¡œì»¬ ê°œë°œìš©
}

// ============================================================================
// bootRun Debug Configuration
// ============================================================================
bootRun {
    // ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œë§Œ ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
    // í”„ë¡œíŒŒì¼ì´ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° 'local'ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    def profile = System.getProperty('spring.profiles.active') ?: 
                  System.getenv('SPRING_PROFILES_ACTIVE') ?: 
                  'local'
    
    // í”„ë¡œíŒŒì¼ì„ JVM ì‹œìŠ¤í…œ í”„ë¡œí¼í‹°ë¡œ ì„¤ì • (ë””ë²„ê·¸ ëª¨ë“œ ê°ì§€ ë° Spring Bootì—ì„œ ì‚¬ìš©)
    systemProperty 'spring.profiles.active', profile
    
    def isLocalEnv = profile in ['local', 'default']
    
    if (isLocalEnv) {
        println "ğŸ› Debug mode enabled for profile: ${profile}"
        jvmArgs = [
            '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005'
        ]
    } else {
        println "âœ… Debug mode disabled for profile: ${profile}"
    }
}