#!/usr/bin/env sh
# ==============================================
# GLIMPSE Pre-commit Hook (Husky)
# ==============================================
# ë¯¼ê°ì •ë³´ ìœ ì¶œ ë°©ì§€ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
# ==============================================

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
GIT_ROOT=$(git rev-parse --show-toplevel)

# í¬ê´„ì ì¸ ë³´ì•ˆ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if [ -f "$GIT_ROOT/scripts/pre-commit-security-check.sh" ]; then
    bash "$GIT_ROOT/scripts/pre-commit-security-check.sh"
    SECURITY_EXIT=$?
    
    if [ $SECURITY_EXIT -ne 0 ]; then
        exit $SECURITY_EXIT
    fi
else
    echo "âš ï¸  ë³´ì•ˆ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "   scripts/pre-commit-security-check.sh íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”."
    
    # ê¸°ë³¸ ê²€ì‚¬ (ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ë•Œ)
    echo "ğŸ” ê¸°ë³¸ ë³´ì•ˆ ì²´í¬ ì‹¤í–‰ ì¤‘..."
    
    FILES=$(git diff --cached --name-only --diff-filter=ACM)
    
    if [ -z "$FILES" ]; then
        echo "âœ… ì»¤ë°‹í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        exit 0
    fi
    
    FOUND_SECRETS=0
    
    # .env íŒŒì¼ ì²´í¬
    for file in $FILES; do
        case "$file" in
            *.env|*.env.local|*.env.production|secrets.env)
                if ! echo "$file" | grep -q "\.example$"; then
                    echo "âŒ ê¸ˆì§€ëœ íŒŒì¼: $file"
                    FOUND_SECRETS=1
                fi
                ;;
            *.pem|*.key|*.p12|*.jks)
                echo "âŒ ê¸ˆì§€ëœ íŒŒì¼: $file"
                FOUND_SECRETS=1
                ;;
        esac
    done
    
    # ê¸°ë³¸ íŒ¨í„´ ì²´í¬
    PATTERNS="sk_live_[a-zA-Z0-9]|sk_test_[a-zA-Z0-9]|AKIA[0-9A-Z]|BEGIN PRIVATE KEY|ghp_[A-Za-z0-9]"
    
    for file in $FILES; do
        if [ -f "$file" ]; then
            if ! echo "$file" | grep -qE "\.example$|\.md$|\.txt$|node_modules"; then
                if grep -qE "$PATTERNS" "$file" 2>/dev/null; then
                    if ! grep -E "$PATTERNS" "$file" | grep -qE "(your_|placeholder|example|sample|test_)"; then
                        echo "âš ï¸  ë¯¼ê°ì •ë³´ ì˜ì‹¬: $file"
                        FOUND_SECRETS=1
                    fi
                fi
            fi
        fi
    done
    
    if [ $FOUND_SECRETS -eq 1 ]; then
        echo ""
        echo "ğŸš¨ ì»¤ë°‹ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ê°•ì œ ì»¤ë°‹: git commit --no-verify"
        exit 1
    fi
fi

echo "âœ… ë³´ì•ˆ ì²´í¬ í†µê³¼!"
exit 0
